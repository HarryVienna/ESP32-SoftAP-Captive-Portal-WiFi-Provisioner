<!DOCTYPE html>
<html>
<head>
    <title>ESP32 WiFi Setup</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" id="mainContainer">
        <h1>WiFi Configuration</h1>
        <form id="configForm">
            
            <label for="ssid">WiFi Network <span id="loader" class="loader"></span></label>
            <div class="select-wrapper">
                <select id="ssid" name="ssid" required>
                    <option value="">Scanning for networks...</option>
                </select>
            </div>
            
            <label for="password">Password</label>
            <div class="input-wrapper">
                <input type="password" id="password" name="password" placeholder="Leave empty for open WiFi">
                <button type="button" id="togglePassword" class="toggle-password">Show</button>
            </div>

            <label for="regionSelect">Region</label>
            <div class="select-wrapper">
                <select id="regionSelect" required>
                    <option value="" selected disabled>Please select a region</option>
                </select>
            </div>

            <label for="timezoneSelect">Timezone</label>
            <div class="select-wrapper">
                <select id="timezoneSelect" required disabled>
                    <option value="" selected disabled>Select a region first</option>
                </select>
            </div>

            <input type="hidden" id="timezoneValue" name="timezone">

            <input type="submit" value="Save & Connect">
        </form>
    </div>

    <script>
        window.onload = function() {
            // --- References to HTML elements ---
            const form = document.getElementById('configForm');
            const mainContainer = document.getElementById('mainContainer');
            const ssidSelect = document.getElementById('ssid');
            const loader = document.getElementById('loader');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const regionSelect = document.getElementById('regionSelect');
            const timezoneSelect = document.getElementById('timezoneSelect');
            const hiddenTimezoneInput = document.getElementById('timezoneValue');

            // --- Timezone Data ---
            // Based on https://github.com/nayarsystems/posix_tz_db
			const timezones = {
                "Africa": [
                    {
                    "city": "Abidjan",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Accra",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Addis_Ababa",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Algiers",
                    "posix": "CET-1"
                    },
                    {
                    "city": "Asmara",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Bamako",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Bangui",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Banjul",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Bissau",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Blantyre",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Brazzaville",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Bujumbura",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Cairo",
                    "posix": "EET-2EEST,M4.5.5/0,M10.5.4/24"
                    },
                    {
                    "city": "Casablanca",
                    "posix": "UTC-1"
                    },
                    {
                    "city": "Ceuta",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Conakry",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Dakar",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Dar_es_Salaam",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Djibouti",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Douala",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "El_Aaiun",
                    "posix": "UTC-1"
                    },
                    {
                    "city": "Freetown",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Gaborone",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Harare",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Johannesburg",
                    "posix": "SAST-2"
                    },
                    {
                    "city": "Juba",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Kampala",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Khartoum",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Kigali",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Kinshasa",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Lagos",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Libreville",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Lome",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Luanda",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Lubumbashi",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Lusaka",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Malabo",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Maputo",
                    "posix": "CAT-2"
                    },
                    {
                    "city": "Maseru",
                    "posix": "SAST-2"
                    },
                    {
                    "city": "Mbabane",
                    "posix": "SAST-2"
                    },
                    {
                    "city": "Mogadishu",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Monrovia",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Nairobi",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Ndjamena",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Niamey",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Nouakchott",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Ouagadougou",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Porto-Novo",
                    "posix": "WAT-1"
                    },
                    {
                    "city": "Sao_Tome",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Tripoli",
                    "posix": "EET-2"
                    },
                    {
                    "city": "Tunis",
                    "posix": "CET-1"
                    },
                    {
                    "city": "Windhoek",
                    "posix": "CAT-2"
                    }
                ],
                "America": [
                    {
                    "city": "Adak",
                    "posix": "HST10HDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Anchorage",
                    "posix": "AKST9AKDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Anguilla",
                    "posix": "AST4"
                    },
                    {
                    "city": "Antigua",
                    "posix": "AST4"
                    },
                    {
                    "city": "Araguaina",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Buenos_Aires",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Catamarca",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Cordoba",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Jujuy",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/La_Rioja",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Mendoza",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Rio_Gallegos",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Salta",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/San_Juan",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/San_Luis",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Tucuman",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Argentina/Ushuaia",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Aruba",
                    "posix": "AST4"
                    },
                    {
                    "city": "Asuncion",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Atikokan",
                    "posix": "EST5"
                    },
                    {
                    "city": "Bahia",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Bahia_Banderas",
                    "posix": "CST6"
                    },
                    {
                    "city": "Barbados",
                    "posix": "AST4"
                    },
                    {
                    "city": "Belem",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Belize",
                    "posix": "CST6"
                    },
                    {
                    "city": "Blanc-Sablon",
                    "posix": "AST4"
                    },
                    {
                    "city": "Boa_Vista",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Bogota",
                    "posix": "UTC5"
                    },
                    {
                    "city": "Boise",
                    "posix": "MST7MDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Cambridge_Bay",
                    "posix": "MST7MDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Campo_Grande",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Cancun",
                    "posix": "EST5"
                    },
                    {
                    "city": "Caracas",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Cayenne",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Cayman",
                    "posix": "EST5"
                    },
                    {
                    "city": "Chicago",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Chihuahua",
                    "posix": "CST6"
                    },
                    {
                    "city": "Costa_Rica",
                    "posix": "CST6"
                    },
                    {
                    "city": "Creston",
                    "posix": "MST7"
                    },
                    {
                    "city": "Cuiaba",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Curacao",
                    "posix": "AST4"
                    },
                    {
                    "city": "Danmarkshavn",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Dawson",
                    "posix": "MST7"
                    },
                    {
                    "city": "Dawson_Creek",
                    "posix": "MST7"
                    },
                    {
                    "city": "Denver",
                    "posix": "MST7MDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Detroit",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Dominica",
                    "posix": "AST4"
                    },
                    {
                    "city": "Edmonton",
                    "posix": "MST7MDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Eirunepe",
                    "posix": "UTC5"
                    },
                    {
                    "city": "El_Salvador",
                    "posix": "CST6"
                    },
                    {
                    "city": "Fort_Nelson",
                    "posix": "MST7"
                    },
                    {
                    "city": "Fortaleza",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Glace_Bay",
                    "posix": "AST4ADT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Godthab",
                    "posix": "UTC2UTC,M3.5.0/-1,M10.5.0/0"
                    },
                    {
                    "city": "Goose_Bay",
                    "posix": "AST4ADT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Grand_Turk",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Grenada",
                    "posix": "AST4"
                    },
                    {
                    "city": "Guadeloupe",
                    "posix": "AST4"
                    },
                    {
                    "city": "Guatemala",
                    "posix": "CST6"
                    },
                    {
                    "city": "Guayaquil",
                    "posix": "UTC5"
                    },
                    {
                    "city": "Guyana",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Halifax",
                    "posix": "AST4ADT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Havana",
                    "posix": "CST5CDT,M3.2.0/0,M11.1.0/1"
                    },
                    {
                    "city": "Hermosillo",
                    "posix": "MST7"
                    },
                    {
                    "city": "Indiana/Indianapolis",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Knox",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Marengo",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Petersburg",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Tell_City",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Vevay",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Vincennes",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Indiana/Winamac",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Inuvik",
                    "posix": "MST7MDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Iqaluit",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Jamaica",
                    "posix": "EST5"
                    },
                    {
                    "city": "Juneau",
                    "posix": "AKST9AKDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Kentucky/Louisville",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Kentucky/Monticello",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Kralendijk",
                    "posix": "AST4"
                    },
                    {
                    "city": "La_Paz",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Lima",
                    "posix": "UTC5"
                    },
                    {
                    "city": "Los_Angeles",
                    "posix": "PST8PDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Lower_Princes",
                    "posix": "AST4"
                    },
                    {
                    "city": "Maceio",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Managua",
                    "posix": "CST6"
                    },
                    {
                    "city": "Manaus",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Marigot",
                    "posix": "AST4"
                    },
                    {
                    "city": "Martinique",
                    "posix": "AST4"
                    },
                    {
                    "city": "Matamoros",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Mazatlan",
                    "posix": "MST7"
                    },
                    {
                    "city": "Menominee",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Merida",
                    "posix": "CST6"
                    },
                    {
                    "city": "Metlakatla",
                    "posix": "AKST9AKDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Mexico_City",
                    "posix": "CST6"
                    },
                    {
                    "city": "Miquelon",
                    "posix": "UTC3UTC,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Moncton",
                    "posix": "AST4ADT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Monterrey",
                    "posix": "CST6"
                    },
                    {
                    "city": "Montevideo",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Montreal",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Montserrat",
                    "posix": "AST4"
                    },
                    {
                    "city": "Nassau",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "New_York",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Nipigon",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Nome",
                    "posix": "AKST9AKDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Noronha",
                    "posix": "UTC2"
                    },
                    {
                    "city": "North_Dakota/Beulah",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "North_Dakota/Center",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "North_Dakota/New_Salem",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Nuuk",
                    "posix": "UTC2UTC,M3.5.0/-1,M10.5.0/0"
                    },
                    {
                    "city": "Ojinaga",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Panama",
                    "posix": "EST5"
                    },
                    {
                    "city": "Pangnirtung",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Paramaribo",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Phoenix",
                    "posix": "MST7"
                    },
                    {
                    "city": "Port-au-Prince",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Port_of_Spain",
                    "posix": "AST4"
                    },
                    {
                    "city": "Porto_Velho",
                    "posix": "UTC4"
                    },
                    {
                    "city": "Puerto_Rico",
                    "posix": "AST4"
                    },
                    {
                    "city": "Punta_Arenas",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Rainy_River",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Rankin_Inlet",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Recife",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Regina",
                    "posix": "CST6"
                    },
                    {
                    "city": "Resolute",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Rio_Branco",
                    "posix": "UTC5"
                    },
                    {
                    "city": "Santarem",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Santiago",
                    "posix": "UTC4UTC,M9.1.6/24,M4.1.6/24"
                    },
                    {
                    "city": "Santo_Domingo",
                    "posix": "AST4"
                    },
                    {
                    "city": "Sao_Paulo",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Scoresbysund",
                    "posix": "UTC2UTC,M3.5.0/-1,M10.5.0/0"
                    },
                    {
                    "city": "Sitka",
                    "posix": "AKST9AKDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "St_Barthelemy",
                    "posix": "AST4"
                    },
                    {
                    "city": "St_Johns",
                    "posix": "NST3:30NDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "St_Kitts",
                    "posix": "AST4"
                    },
                    {
                    "city": "St_Lucia",
                    "posix": "AST4"
                    },
                    {
                    "city": "St_Thomas",
                    "posix": "AST4"
                    },
                    {
                    "city": "St_Vincent",
                    "posix": "AST4"
                    },
                    {
                    "city": "Swift_Current",
                    "posix": "CST6"
                    },
                    {
                    "city": "Tegucigalpa",
                    "posix": "CST6"
                    },
                    {
                    "city": "Thule",
                    "posix": "AST4ADT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Thunder_Bay",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Tijuana",
                    "posix": "PST8PDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Toronto",
                    "posix": "EST5EDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Tortola",
                    "posix": "AST4"
                    },
                    {
                    "city": "Vancouver",
                    "posix": "PST8PDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Whitehorse",
                    "posix": "MST7"
                    },
                    {
                    "city": "Winnipeg",
                    "posix": "CST6CDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Yakutat",
                    "posix": "AKST9AKDT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Yellowknife",
                    "posix": "MST7MDT,M3.2.0,M11.1.0"
                    }
                ],
                "Antarctica": [
                    {
                    "city": "Casey",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Davis",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "DumontDUrville",
                    "posix": "UTC-10"
                    },
                    {
                    "city": "Macquarie",
                    "posix": "AEST-10AEDT,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Mawson",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "McMurdo",
                    "posix": "NZST-12NZDT,M9.5.0,M4.1.0/3"
                    },
                    {
                    "city": "Palmer",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Rothera",
                    "posix": "UTC3"
                    },
                    {
                    "city": "Syowa",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Troll",
                    "posix": "UTC0UTC-2,M3.5.0/1,M10.5.0/3"
                    },
                    {
                    "city": "Vostok",
                    "posix": "UTC-5"
                    }
                ],
                "Arctic": [
                    {
                    "city": "Longyearbyen",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    }
                ],
                "Asia": [
                    {
                    "city": "Aden",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Almaty",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Amman",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Anadyr",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Aqtau",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Aqtobe",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Ashgabat",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Atyrau",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Baghdad",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Bahrain",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Baku",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Bangkok",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Barnaul",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Beirut",
                    "posix": "EET-2EEST,M3.5.0/0,M10.5.0/0"
                    },
                    {
                    "city": "Bishkek",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "Brunei",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Chita",
                    "posix": "UTC-9"
                    },
                    {
                    "city": "Choibalsan",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Colombo",
                    "posix": "UTC-5:30"
                    },
                    {
                    "city": "Damascus",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Dhaka",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "Dili",
                    "posix": "UTC-9"
                    },
                    {
                    "city": "Dubai",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Dushanbe",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Famagusta",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Gaza",
                    "posix": "EET-2EEST,M3.4.4/50,M10.4.4/50"
                    },
                    {
                    "city": "Hebron",
                    "posix": "EET-2EEST,M3.4.4/50,M10.4.4/50"
                    },
                    {
                    "city": "Ho_Chi_Minh",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Hong_Kong",
                    "posix": "HKT-8"
                    },
                    {
                    "city": "Hovd",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Irkutsk",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Jakarta",
                    "posix": "WIB-7"
                    },
                    {
                    "city": "Jayapura",
                    "posix": "WIT-9"
                    },
                    {
                    "city": "Jerusalem",
                    "posix": "IST-2IDT,M3.4.4/26,M10.5.0"
                    },
                    {
                    "city": "Kabul",
                    "posix": "UTC-4:30"
                    },
                    {
                    "city": "Kamchatka",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Karachi",
                    "posix": "PKT-5"
                    },
                    {
                    "city": "Kathmandu",
                    "posix": "UTC-5:45"
                    },
                    {
                    "city": "Khandyga",
                    "posix": "UTC-9"
                    },
                    {
                    "city": "Kolkata",
                    "posix": "IST-5:30"
                    },
                    {
                    "city": "Krasnoyarsk",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Kuala_Lumpur",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Kuching",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Kuwait",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Macau",
                    "posix": "CST-8"
                    },
                    {
                    "city": "Magadan",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Makassar",
                    "posix": "WITA-8"
                    },
                    {
                    "city": "Manila",
                    "posix": "PST-8"
                    },
                    {
                    "city": "Muscat",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Nicosia",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Novokuznetsk",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Novosibirsk",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Omsk",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "Oral",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Phnom_Penh",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Pontianak",
                    "posix": "WIB-7"
                    },
                    {
                    "city": "Pyongyang",
                    "posix": "KST-9"
                    },
                    {
                    "city": "Qatar",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Qyzylorda",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Riyadh",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Sakhalin",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Samarkand",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Seoul",
                    "posix": "KST-9"
                    },
                    {
                    "city": "Shanghai",
                    "posix": "CST-8"
                    },
                    {
                    "city": "Singapore",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Srednekolymsk",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Taipei",
                    "posix": "CST-8"
                    },
                    {
                    "city": "Tashkent",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Tbilisi",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Tehran",
                    "posix": "UTC-3:30"
                    },
                    {
                    "city": "Thimphu",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "Tokyo",
                    "posix": "JST-9"
                    },
                    {
                    "city": "Tomsk",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Ulaanbaatar",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "Urumqi",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "Ust-Nera",
                    "posix": "UTC-10"
                    },
                    {
                    "city": "Vientiane",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Vladivostok",
                    "posix": "UTC-10"
                    },
                    {
                    "city": "Yakutsk",
                    "posix": "UTC-9"
                    },
                    {
                    "city": "Yangon",
                    "posix": "UTC-6:30"
                    },
                    {
                    "city": "Yekaterinburg",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Yerevan",
                    "posix": "UTC-4"
                    }
                ],
                "Atlantic": [
                    {
                    "city": "Azores",
                    "posix": "UTC1UTC,M3.5.0/0,M10.5.0/1"
                    },
                    {
                    "city": "Bermuda",
                    "posix": "AST4ADT,M3.2.0,M11.1.0"
                    },
                    {
                    "city": "Canary",
                    "posix": "WET0WEST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Cape_Verde",
                    "posix": "UTC1"
                    },
                    {
                    "city": "Faroe",
                    "posix": "WET0WEST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Madeira",
                    "posix": "WET0WEST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Reykjavik",
                    "posix": "GMT0"
                    },
                    {
                    "city": "South_Georgia",
                    "posix": "UTC2"
                    },
                    {
                    "city": "St_Helena",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Stanley",
                    "posix": "UTC3"
                    }
                ],
                "Australia": [
                    {
                    "city": "Adelaide",
                    "posix": "ACST-9:30ACDT,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Brisbane",
                    "posix": "AEST-10"
                    },
                    {
                    "city": "Broken_Hill",
                    "posix": "ACST-9:30ACDT,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Currie",
                    "posix": "AEST-10AEDT,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Darwin",
                    "posix": "ACST-9:30"
                    },
                    {
                    "city": "Eucla",
                    "posix": "UTC-8:45"
                    },
                    {
                    "city": "Hobart",
                    "posix": "AEST-10AEDT,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Lindeman",
                    "posix": "AEST-10"
                    },
                    {
                    "city": "Lord_Howe",
                    "posix": "UTC-10:30UTC-11,M10.1.0,M4.1.0"
                    },
                    {
                    "city": "Melbourne",
                    "posix": "AEST-10AEDT,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Perth",
                    "posix": "AWST-8"
                    },
                    {
                    "city": "Sydney",
                    "posix": "AEST-10AEDT,M10.1.0,M4.1.0/3"
                    }
                ],
                "Etc": [
                    {
                    "city": "GMT",
                    "posix": "GMT0"
                    },
                    {
                    "city": "GMT+0",
                    "posix": "GMT0"
                    },
                    {
                    "city": "GMT+1",
                    "posix": "UTC1"
                    },
                    {
                    "city": "GMT+10",
                    "posix": "UTC10"
                    },
                    {
                    "city": "GMT+11",
                    "posix": "UTC11"
                    },
                    {
                    "city": "GMT+12",
                    "posix": "UTC12"
                    },
                    {
                    "city": "GMT+2",
                    "posix": "UTC2"
                    },
                    {
                    "city": "GMT+3",
                    "posix": "UTC3"
                    },
                    {
                    "city": "GMT+4",
                    "posix": "UTC4"
                    },
                    {
                    "city": "GMT+5",
                    "posix": "UTC5"
                    },
                    {
                    "city": "GMT+6",
                    "posix": "UTC6"
                    },
                    {
                    "city": "GMT+7",
                    "posix": "UTC7"
                    },
                    {
                    "city": "GMT+8",
                    "posix": "UTC8"
                    },
                    {
                    "city": "GMT+9",
                    "posix": "UTC9"
                    },
                    {
                    "city": "GMT-0",
                    "posix": "GMT0"
                    },
                    {
                    "city": "GMT-1",
                    "posix": "UTC-1"
                    },
                    {
                    "city": "GMT-10",
                    "posix": "UTC-10"
                    },
                    {
                    "city": "GMT-11",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "GMT-12",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "GMT-13",
                    "posix": "UTC-13"
                    },
                    {
                    "city": "GMT-14",
                    "posix": "UTC-14"
                    },
                    {
                    "city": "GMT-2",
                    "posix": "UTC-2"
                    },
                    {
                    "city": "GMT-3",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "GMT-4",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "GMT-5",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "GMT-6",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "GMT-7",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "GMT-8",
                    "posix": "UTC-8"
                    },
                    {
                    "city": "GMT-9",
                    "posix": "UTC-9"
                    },
                    {
                    "city": "GMT0",
                    "posix": "GMT0"
                    },
                    {
                    "city": "Greenwich",
                    "posix": "GMT0"
                    },
                    {
                    "city": "UCT",
                    "posix": "UTC0"
                    },
                    {
                    "city": "Universal",
                    "posix": "UTC0"
                    },
                    {
                    "city": "UTC",
                    "posix": "UTC0"
                    },
                    {
                    "city": "Zulu",
                    "posix": "UTC0"
                    }
                ],
                "Europe": [
                    {
                    "city": "Amsterdam",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Andorra",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Astrakhan",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Athens",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Belgrade",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Berlin",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Bratislava",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Brussels",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Bucharest",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Budapest",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Busingen",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Chisinau",
                    "posix": "EET-2EEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Copenhagen",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Dublin",
                    "posix": "IST-1GMT0,M10.5.0,M3.5.0/1"
                    },
                    {
                    "city": "Gibraltar",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Guernsey",
                    "posix": "GMT0BST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Helsinki",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Isle_of_Man",
                    "posix": "GMT0BST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Istanbul",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Jersey",
                    "posix": "GMT0BST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Kaliningrad",
                    "posix": "EET-2"
                    },
                    {
                    "city": "Kiev",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Kirov",
                    "posix": "MSK-3"
                    },
                    {
                    "city": "Lisbon",
                    "posix": "WET0WEST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Ljubljana",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "London",
                    "posix": "GMT0BST,M3.5.0/1,M10.5.0"
                    },
                    {
                    "city": "Luxembourg",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Madrid",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Malta",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Mariehamn",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Minsk",
                    "posix": "UTC-3"
                    },
                    {
                    "city": "Monaco",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Moscow",
                    "posix": "MSK-3"
                    },
                    {
                    "city": "Oslo",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Paris",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Podgorica",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Prague",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Riga",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Rome",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Samara",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "San_Marino",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Sarajevo",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Saratov",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Simferopol",
                    "posix": "MSK-3"
                    },
                    {
                    "city": "Skopje",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Sofia",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Stockholm",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Tallinn",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Tirane",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Ulyanovsk",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Uzhgorod",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Vaduz",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Vatican",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Vienna",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Vilnius",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Volgograd",
                    "posix": "MSK-3"
                    },
                    {
                    "city": "Warsaw",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Zagreb",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    },
                    {
                    "city": "Zaporozhye",
                    "posix": "EET-2EEST,M3.5.0/3,M10.5.0/4"
                    },
                    {
                    "city": "Zurich",
                    "posix": "CET-1CEST,M3.5.0,M10.5.0/3"
                    }
                ],
                "Indian": [
                    {
                    "city": "Antananarivo",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Chagos",
                    "posix": "UTC-6"
                    },
                    {
                    "city": "Christmas",
                    "posix": "UTC-7"
                    },
                    {
                    "city": "Cocos",
                    "posix": "UTC-6:30"
                    },
                    {
                    "city": "Comoro",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Kerguelen",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Mahe",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Maldives",
                    "posix": "UTC-5"
                    },
                    {
                    "city": "Mauritius",
                    "posix": "UTC-4"
                    },
                    {
                    "city": "Mayotte",
                    "posix": "EAT-3"
                    },
                    {
                    "city": "Reunion",
                    "posix": "UTC-4"
                    }
                ],
                "Pacific": [
                    {
                    "city": "Apia",
                    "posix": "UTC-13"
                    },
                    {
                    "city": "Auckland",
                    "posix": "NZST-12NZDT,M9.5.0,M4.1.0/3"
                    },
                    {
                    "city": "Bougainville",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Chatham",
                    "posix": "UTC-12:45UTC,M9.5.0/2:45,M4.1.0/3:45"
                    },
                    {
                    "city": "Chuuk",
                    "posix": "UTC-10"
                    },
                    {
                    "city": "Easter",
                    "posix": "UTC6UTC,M9.1.6/22,M4.1.6/22"
                    },
                    {
                    "city": "Efate",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Enderbury",
                    "posix": "UTC-13"
                    },
                    {
                    "city": "Fakaofo",
                    "posix": "UTC-13"
                    },
                    {
                    "city": "Fiji",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Funafuti",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Galapagos",
                    "posix": "UTC6"
                    },
                    {
                    "city": "Gambier",
                    "posix": "UTC9"
                    },
                    {
                    "city": "Guadalcanal",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Guam",
                    "posix": "ChST-10"
                    },
                    {
                    "city": "Honolulu",
                    "posix": "HST10"
                    },
                    {
                    "city": "Kiritimati",
                    "posix": "UTC-14"
                    },
                    {
                    "city": "Kosrae",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Kwajalein",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Majuro",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Marquesas",
                    "posix": "UTC9:30"
                    },
                    {
                    "city": "Midway",
                    "posix": "SST11"
                    },
                    {
                    "city": "Nauru",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Niue",
                    "posix": "UTC11"
                    },
                    {
                    "city": "Norfolk",
                    "posix": "UTC-11UTC,M10.1.0,M4.1.0/3"
                    },
                    {
                    "city": "Noumea",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Pago_Pago",
                    "posix": "SST11"
                    },
                    {
                    "city": "Palau",
                    "posix": "UTC-9"
                    },
                    {
                    "city": "Pitcairn",
                    "posix": "UTC8"
                    },
                    {
                    "city": "Pohnpei",
                    "posix": "UTC-11"
                    },
                    {
                    "city": "Port_Moresby",
                    "posix": "UTC-10"
                    },
                    {
                    "city": "Rarotonga",
                    "posix": "UTC10"
                    },
                    {
                    "city": "Saipan",
                    "posix": "ChST-10"
                    },
                    {
                    "city": "Tahiti",
                    "posix": "UTC10"
                    },
                    {
                    "city": "Tarawa",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Tongatapu",
                    "posix": "UTC-13"
                    },
                    {
                    "city": "Wake",
                    "posix": "UTC-12"
                    },
                    {
                    "city": "Wallis",
                    "posix": "UTC-12"
                    }
                ]
                };

            // --- Form Submit Logic ---
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const submitButton = form.querySelector('input[type="submit"]');
                submitButton.value = "Saving...";
                submitButton.disabled = true;
                
                fetch('/save', {
                    method: 'POST',
                    body: new URLSearchParams(new FormData(form))
                })
                .then(response => {
                    if (response.ok) {
                        mainContainer.innerHTML = `
                            <h1>Configuration Received</h1>
                            <p style="text-align:center; font-size: 1.1em;">
                                The device will now attempt to connect to the WiFi.
                                <br><br>
                                You can now close this window.
                            </p>`;
                    } else { throw new Error('Server response was not OK'); }
                })
                .catch(error => {
                    console.error('Error Saving:', error);
                    mainContainer.innerHTML = `
                            <h1>Error Saving</h1>
                            <p style="text-align:center;">
                                The configuration could not be saved. Please try again.
                            </p>`;
                });
            });

            // --- WiFi Scan Logic ---
            fetch('/scan.json')
                .then(response => response.json())
                .then(data => {
                    ssidSelect.innerHTML = '<option value="">Please select a network</option>';
                    if (data.aps && data.aps.length > 0) {
                        data.aps.forEach(ap => {
                            const option = new Option(ap.ssid, ap.ssid);
                            ssidSelect.add(option);
                        });
                    } else {
                        ssidSelect.innerHTML = '<option value="">No networks found</option>';
                    }
                    loader.style.visibility = 'hidden';
                })
                .catch(error => {
                    console.error('Error during WiFi scan:', error);
                    ssidSelect.innerHTML = '<option value="">Scan failed</option>';
                    loader.style.visibility = 'hidden';
                });

            // --- Password Toggle Logic ---
            togglePassword.addEventListener('click', function () {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.textContent = type === 'password' ? 'Show' : 'Hide';
            });

            // --- Coupled Dropdown Logic for Timezones (ADAPTED) ---
            const regions = Object.keys(timezones);
            regions.sort().forEach(region => { // .sort() for alphabetical order
                const option = new Option(region, region);
                regionSelect.add(option);
            });

            regionSelect.addEventListener('change', function() {
                const selectedRegion = this.value;
                timezoneSelect.innerHTML = '<option value="" selected disabled>Please select a timezone</option>';
                hiddenTimezoneInput.value = '';
                
                const regionTimezones = timezones[selectedRegion] || [];
                regionTimezones.forEach(tz => {
                    const cityNameForDisplay = tz.city.replace(/_/g, ' ');
                    // The value is the city itself (tz.city), not tz.posix
                    const option = new Option(cityNameForDisplay, tz.city);
                    timezoneSelect.add(option);
                });
                timezoneSelect.disabled = false;
            });

            timezoneSelect.addEventListener('change', function() {
                const selectedRegion = regionSelect.value;
                const selectedCity = this.value; // This is the city name, e.g., "Vienna"

                if (selectedRegion && selectedCity) {
                    const timezoneData = timezones[selectedRegion].find(tz => tz.city === selectedCity);
                    if (timezoneData) {
                        hiddenTimezoneInput.value = timezoneData.posix;
                    }
                }
            });
            
            function autoSelectTimezone() {
                try {
                    const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone; // e.g., "Europe/Vienna"

                    if (!userTimezone || !userTimezone.includes('/')) {
                        return;
                    }

                    const [region, city] = userTimezone.split('/', 2); // e.g., region="Europe", city="Vienna"

                    // Check if the detected region exists in our data
                    if (timezones[region]) {
                        // Find the matching city in the region
                        const timezoneData = timezones[region].find(tz => tz.city === city);

                        if (timezoneData) {
                            // 1. Select region in the dropdown
                            regionSelect.value = region;
                            // 2. Manually trigger the "change" event to populate the timezone dropdown
                            regionSelect.dispatchEvent(new Event('change'));
                            // 3. Select the correct timezone (city) in the second dropdown
                            timezoneSelect.value = timezoneData.city;
                            // 4. Trigger the "change" event again to update the hidden field
                            timezoneSelect.dispatchEvent(new Event('change'));
                        }
                    }
                } catch (e) {
                    console.error("Error during automatic timezone detection:", e);
                }
            }

            // Call the auto-select function directly after loading
            autoSelectTimezone();
        };
    </script>
</body>
</html>